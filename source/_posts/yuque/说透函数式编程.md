---
title: 说透函数式编程
urlname: kegf2o
date: '2021-05-22 13:18:37 +0000'
tags: []
categories: []
---

说到函数式编程，不得不提到数学里的函数，例如数学公式 x=f(y)就很好的描述了 x 和 y 的映射关系，其实，函数式编程正来源于此。

## 是什么

函数式编程(Function Programming FP)，FP 是编程范式之一。
函数式编程是一个很古老的概念，它和面向对象等概念是并列的，我们可以认为它是一种如何编写代码的“方法论”。
函数式编程的思维方式是把现实世界的事物和事物之间的联系抽象到程序世界，在程序中对运算过程进行抽象，具体的做法是，根据输入某种运算获得相应的输出，因为程序开发过程中会涉及很多有输入和输出的函数。
有一点需要注意的是，函数式编程中的函数指的不是程序中的函数，而是数学中的函数，即不同数据之间的映射关系。

```javascript
// 数学中的函数
y = sin(x); // 描述x和y之间的映射关系
```

由此可见在函数式编程的中，对于相同的输入，函数的输出是恒定的，也就是没有副作用的纯函数；没有副作用的意思是它的输出不会因为外部变量的变化而发生变化。

上面说它是一种“方法论”，那么我们为什么要使用这种“方法论”呢？要想弄清楚这个问题，我们可以从使用函数式编程有什么好处来作为切入口。

## 使用函数式编程的好处

- 函数式编程可以抛弃 this，不再向面向对象那样经常用到 this
- 打包过程中可以更好的利用 tree shaking 过滤无用代码
- 方便测试和并行处理

了解了它的好处，下面来介绍常见的函数式编程都有哪些？不过在此之前，我们先来了解一下函数是一等公民的概念，因为它是后续高阶函数、柯里化等的基础。

## 函数是一等公民

在 JavaScript 中函数就是一个普通的对象(可以通过 new Function()创建)，我们可以把函数存储到变量、数组、对象中，它还可以作为另一个函数的参数和返回值，甚至我们可以在程序运行的时候通过 new Function('alert(1)')来构造一个新的函数。
总结来说，函数是一等公民，它有以下特点：

- 函数可以存储在变量中
- 函数可以作为参数
- 函数可以作为返回值

## 高阶函数

高阶函数(Higher-order-function)的定义是：可以把函数作为参数传递给另一个函数；可以把函数作为另一个函数的返回结果。
我们为什么要使用高阶函数呢？

### 使用高阶函数的意义/好处

- 使函数抽象化，可以帮我们屏蔽实现细节，每次在调用函数时，我们只需要关注想要的目标。
- 对通用问题进行抽象，方便重复调用
- 使代码更加简洁

## 闭包

闭包(Closure)的定义是：函数和周围的状态(词法环境)的引用捆绑在一起形成闭包。
换句话说就是，闭包的形成是因为函数引用了当前作用域以外的其他作用域中的变量。

深入函数执行机制，函数执行会形成一个执行栈，当执行栈中的内容被执行完成之后，会被游览器垃圾回收机制移除。但如果堆上的作用域成员被外部引用，是不会被移除的，因此内部函数依然可以访问外部函数中的成员。这就是闭包的本质。

### 使用闭包的好处

延长了外部函数中的变量的作用范围。

## 纯函数

纯函数的概念其实很简单：“相同的输入永远会得到相同的输出”。
也就是我们重复调用同一个函数，函数的返回值是和函数的参数一一对应的。我们可以把纯函数理解为数学中的函数，比如数学中常见的数学公式：y=f(x)，它描述了数据与数据之间(x 和 y)的映射关系。
纯函数的特点就是不会保留中间的计算结果，比如无法访问函数内部的运算中间结果，因为它不会对计算结果做数据持久化，并且变量是不可变的，所以纯函数是无状态的。

### 使用纯函数的好处

- 可缓存：由于纯函数相同的输入始终有相同的输出，我们就可以把函数的结果**缓存**起来，避免重复调用，提高性能。
- 方便测试
- 方便并行处理：在多线程环境下，避免并行操作共享的内存数据引发的意外情况。

## 副作用

副作用会让一个函数变得不纯，纯函数根据相同的输入返回相同的输出，如果一个函数依赖于外部的状态就无法保证函数输出相同，就会带来副作用。
副作用可能的来源：配置文件、数据库、获取用户的输入等。
所有的外部交互都有可能导致副作用，副作用也使得方法通用性下降不适合可扩展性和通用性，同时副作用会给程序中带来安全隐患和不确定性，但是副作用不可能完全禁止，我们应该尽可能控制他们在可控的范围内发生。

## 柯里化(Curry)

当一个函数有多个参数的时候，先传一部分参数并调用它，这部分参数以后永远不变。然后返回一个新的函数接收剩余的参数，最后返回结果。
柯里化可以让我们给一个函数传递较少的参数得到一个已经记住了某些固定参数的新函数。因此，柯里化是一种对函数参数的**缓存**。

### 柯里化的好处

- 让函数变得灵活，让函数的粒度变得更小
- 可以把多元函数转换成一元函数，可以组合使用函数产生强大的功能。

### 通用柯里化函数

```javascript
function curry(fn) {
  return function iner(...args) {
    if (fn.length !== args.length) {
      return iner(args.concat(Array.from(arguments)));
    } else {
      fn.apply(fn, args);
    }
  };
}
```

## 函数组合(compose)

纯函数和柯里化函数很容易写出洋葱代码，这是我们不希望看到的。而函数组合可以让我们把细粒度的函数重新组合生成一个新的函数。

### 实现原理

```javascript
function compose(...args) {
  return function (value) {
    return args.reduceRight(function (ret, fn) {
      return fn(ret);
    }, value);
  };
}
```

函数组合需要满足**结合律**，假如有三个函数 a、b、c，我们可以先把 a、b 函数组合，然后再组合 c；也可以先把 b、c 组合，然后再组合 a，结果是一样的。
